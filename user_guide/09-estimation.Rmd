# Estimation in VisionEval {#ve-estimation}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(knitr)
library(dplyr)
library(kableExtra)
options(kableExtra.html.bsTable = TRUE)
library(data.table)
library(openxlsx)

```
```{r read_inputs, include=FALSE}

# Summary spreadsheet
dt <- read.xlsx("./data/Pooled_Funds_Task4_VE_Estimation.xlsx",sheet = "Sheet1", startRow = 5)
dt <- data.table(dt)[, AssignedTo := NULL]

# function to concanate a list with commas
conc_vector <- function(vec){
  if(!is.null(vec)){
  
    if(length(vec) == 0){
     conc_vec <- "none"
    }
    if(length(vec) == 1){
     conc_vec <- vec
    }
    if(length(vec) == 2){
      conc_vec <- paste(vec[1], "and", vec[2])
    }
    if(length(vec) > 2){
      conc_vec <- paste(paste(vec[1:(length(vec)-1)], sep = ", "), "and", vec[length(vec)])
    }
    
  } else {
    conc_vec <- "none"
  }
    
  return(conc_vec)  
}


```

## Overview 

Model estimation in VisionEval, either statistical estimation of model parameters (such as estimating linear regression or logit models) or tabulation of external data to produce model parameters, is designed to be integrated into VE modules and to take place during the build process of the modules into packages. 

While this is convenient, the current process in existing VE modules has limitations:

* It is difficult to replace models with local or updated data due to complexity and lack of documentation
* Several modules obscure data and parameters in the estimation portion of the package and therefore require package rebuilds if changes are made
* Legacy model estimation is incorporated in several modules, e.g., modules that were part of the RPAT model
* There are data discontinuities preventing users from estimating models where, for example, restricted or confidential data have been used to estimate model components (e.g., use of restricted spatial data in VETravelDemandMM) preventing the data from being included in the model package.

This chapter forms an element of work to improve the ability for those applying VE to incorporate newer publicly available datasets or custom datasets to develop locally relevant models for use in VE. This work will include defining a process for users to make use of the latest NHTS data, local HTS data, and local PUMS data, to update models estimated using older versions of the NHTS and PUMS data from different states or regions. 

This chapter includes a classification of the source data and estimation approaches with respect to how important it might be to re-estimate models using localized and/or updated versions of the source information, and whether the estimation approach used in those packages forms a barrier to that re-estimation. The discussion is intended to provide input to the next step of work, which is designed approaches to improve the flexiblity and usability of the estimation procedures in VE. 

This chapter includes a detailed catalog of estimated models in all of the VE modules and lists the underlying data used in the estimation process for each module.

## VE Estimation Classification

There are several main estimation methods used in current VE modules. Their characteristics are discussed here with particular focus on places where the methods already lend themselves to updates and places where the current approach makes updates the package by users more difficult. The specific data sources and approaches used for each module is cataloged in detail in the section [VE Modules With Estimation] below.

### Modules importing data from VENHTS2001

The VENHTS2001 module processes the 2001 NHTS publically available datasets to create a household dataset which is augmented with other public data on transport supply. The built VENHTS2001 package can then be used in other modules to support model estimation. For example, the VEHouseholdTravel uses the data output by the VENHTS2001 package to estimate its various travel demand models. There are instances of a second round of dependencies, where models estimated using the data from the VENHTS2001 package are used in the estimation of additional models, for example in the VEPowertrainsAndFuels module.

The general approach is shown here:

```
* VENHTS2001
  + Make2001NHTSDataset: process NHTS data and add FHWA HPMS and FTA NTD
  + Creates NHTS data frame on package build
* VEHouseholdTravel
  + CalculateAltModeTrips: estimates models of household transit trips, walk trips, and bike trips
  + CalculateHouseholdDvmt: estimates models of household average daily vehicle miles traveled
  + (other components in VEHouseholdTravel also estimate models with VENHTS2001)
  + Creates estimated model objects on package build
* VEHouseholdVehicles
  + AssignDrivers: estimates model to assign drivers by age group to each household
  + (other components in VEHouseholdVehicles also estimate models with VENHTS2001)
  + Creates estimated model objects on package build
* VEPowertrainsAndFuels
  + AssignHhVehiclePowertrain: 
    - estimates model to assign a powertrain type to each household vehicle. 
    - uses the VEHouseholdTravel::DvmtModel_ls, which is based on VENHTS2001, for estimation
    - Creates estimated model objects on package build
  
```

This sequential and modularized approach, where data processing is contained in one package, and then those data are used to support estimation in several other modules, lends itself well to incorporating updated datasets. In this case, alterantive versions of the NHTS might be substituted for the 2001 NHTS, or a local household travel survey could be used in place of the NHTS, as long as the output format currently used in the VENHTS2001 package was conformed with.

The development requirements here are:

* A method to select between different household travel source data during the package build process.
* A documented approach to developing alternative household travel survey source data in the correct format.
* NHTS 2009 and NHTS 2017 packages consistent with the NHTS 2001 package to allow for substitution with newer versions of the NHTS.

### Modules using confidential NHTS data

The use of publically available data for model estimation, where the data and estimation scripts are included in modules and are freely available to model users, is an attractive aspect of VE. 

A new package developed using the NHTS 2009, VETravelDemandMM, doesn't fully conform to this ideal. Estimation in this package incorporates neighborhood land use characteristics around each of the NHTS households taken from the EPA's Smart Location Database. However, the connection between the NHTS and the SLD requires the data item describing the Census blockgroup of the household, which is a confidential data item only provided to researchers by FHWA following the completion of a nno-disclosure process. 

In this case, estimated model objects can be included in the package but the estimation data cannot be included, preventing easy re-estimation of the models by other developers.

The development requirements here are:

* Consider alternative methods for attributing the NHTS with the neighboorhood land use variables that might not require confidentiality requriements.

### Modules imported from RPAT

VERPAT is the VE implementation of the RPAT model, which was originally developed as part of the SHRP 2 C16 project. While the RPAT model was converted to run as a set of VE modules, the modules do not incorporate model estimation during package build. In most cases, RPAT used models imported from the GreenSTEP model, which were later incorporated into VE and form the basis of many of the models still used in, for example, the VEHouseholdTravel module.

If VERPAT is to be maintained, it would be of benefit to re-establish the connections back to the model estimation porcesses used in modules such as VEHouseholdTravel and VEHouseholdVehicles

The development requirements here are:

* Identify the specific connections between VERPAT models and the locations where those models are now estimated in VE modules.
* Replace the hardcoded models and imported model objects currently used in VERPAT modules with references to the models estimated during a build of VE. This would allow, for example, connections to updated NHTS data and/or local household travel survey data discussed above. 

### Modules estimated with local data

In some cases, locally specific data were used to develop model inputs and estimate models that are incorporated into modules. One example is the use of the Census Public User Microdata Sample (PUMS) for Oregon, which is used to estimate income modles and to develop probability distributions used in the VESimHouseholds package. 

Ideally, the implementation of a VE model in another state would replace the Oregeon data with a local dataset. The data are also from 2001, and would ideally be replaced with a more recent version of the PUMS data, for example from the American Community Survey (ACS) 5 year data or an alternative local data source.

The development requirements here are:

* Documentation of an approach to replace the 2001 Oregon data with an alternative data source
* Consider the development of a seperate package or module in VESimHouseholds to process a selected state or region's ACS data via an automatic download or API call to source the data.

### Modules estimated with other types of data

Several other data sources are used in the development of modules, particularly those that deal with vehicle operations and congestion. There are generally reasonably well documented. The estimation work could be considered for updating by model users where local conditions are sufficiently different from those covered in the original estimation date, or over time as the origimal estimation data being aged and are superceded.

The development requirements here are:

* Further refine the cataloging of estimation work in this chapter to clearly identify each data source and its vintage.
* Identify the public availability (or not) of the data source and whether more recent data are already available.

## VE Modules With Estimation

The table lists the VE modules that currently exist and whether they include estimation. Several of the modules, notably the original and more recently developed household travel modules (VEHouseholdTravel and VETravelDemandMM) contain a high number of estimated models. Several modules include no estimation.

```{r est-modules-estimation, fig.cap="VE Modules that Include Estimation"}

dt[, Estimated := ifelse(!is.na(Model) & !grepl("This module has no estimated parameters", Model),1,0)]

dat <- dt[, .(EstimatedComponents = sum(Estimated)), keyby = Module]
knitr::kable(dat,
             col.names = c("Module Name", "Estimated Components and Models"),
             digits = 0)

```

This section describes the estimation that takes places in each module.

```{r est-module-summary, results='asis'}

# Loop through each module as a heading
# Module step as a sub heading
# Quick summary of estimation approach, sources, model types, and documentation
# Characteristics to report in detail
# - Models within each module step as a bulleted list
# -- for each model describe the estimation approach, estimation data, 
#    estimation script, and output model object

for(i in 1:dt[,.(uniqueN(Module))]$V1){
  # loop through modules
  module <- dt[,.(Module = unique(Module))]$Module[i]
  cat('\n')  
  cat('### ', module, '\n') 
  cat('\n')
  cat(dt[Module == module]$ModuleDescription[1])
  cat('\n')
  cat('This module contains the following step(s):', '\n', '\n')
  for(j in 1:dt[Module == module,.(uniqueN(ModuleStep))]$V1){
    
    # Loop through steps
    
    module_step <- dt[Module == module, .(ModuleStep = unique(ModuleStep))]$ModuleStep[j]
    cat('#### ', module_step, '\n')
    cat('\n')  
    cat(dt[Module == module & ModuleStep == module_step]$ModuleStepDescription[1], '\n')
    cat('\n')
    
    # Not all steps include estimated models
    if(nrow(dt[Module == module & ModuleStep == module_step & !is.na(Model) & !grepl("no estimated parameters",Model)]) == 0){
      cat('This module step has no estimated parameters or other model types derived from data.', '\n', '\n')
    } else {
      cat('* Data sources include', 
        conc_vector(unique(dt[Module == module & ModuleStep == module_step & !is.na(DataSource)]$DataSource)), 
        '\n')
      cat('* Model types include', 
        conc_vector(unique(dt[Module == module & ModuleStep == module_step & !is.na(ModelType)]$ModelType)), 
        '\n')
      cat('* Estimation uses the following methods:', 
        conc_vector(unique(dt[Module == module & ModuleStep == module_step & !is.na(EstimationApproach)]$EstimationApproach)), 
        '\n')
      cat('* Documented in', 
        conc_vector(unique(dt[Module == module & ModuleStep == module_step & !is.na(Documentation)]$Documentation)), 
        '\n')
      
      cat('\n')
      
      # Loop through the models
      cat('The models in this model step are:', '\n', '\n')
      
      unique_models <- dt[Module == module & ModuleStep == module_step & !is.na(Model) & !grepl("no estimated parameters", Model), uniqueN(Model)]
      
      for(k in 1:unique_models){
        
        model_name <- dt[Module == module & ModuleStep == module_step & !is.na(Model)]$Model[k]
         
        cat('* Model name:', model_name, '\n')
        cat('  + Model type:', dt[Module == module & ModuleStep == module_step & Model == model_name]$ModelType, '\n')
        cat('  + Estimation data:', dt[Module == module & ModuleStep == module_step & Model == model_name]$EstimationData, '\n')
        cat('  + Estimation method:', dt[Module == module & ModuleStep == module_step & Model == model_name]$EstimationApproach, '\n')
        cat('  + Estimation script:', dt[Module == module & ModuleStep == module_step & Model == model_name]$EstimationScript, '\n')
        cat('  + Model object:', dt[Module == module & ModuleStep == module_step & Model == model_name]$OutputModel, '\n')
        cat('  + Notes:', dt[Module == module & ModuleStep == module_step & Model == model_name]$Notes, '\n')
        cat('\n')  
        
      } #Close K loop
    }  # Close if
  } # close j loop
} # close i loop


```